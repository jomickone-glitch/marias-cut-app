<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maria's Cut</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F9F7F2">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="778405F5-FB9C-47F4-908A-185070ECD1DC.PNG">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#C5A059',
                        primaryDark: '#A88B45',
                        secondary: '#D4B896',
                        secondaryDark: '#B89C7A',
                        background: '#F9F7F2',
                        gold: '#D4AF37',
                        goldLight: '#E8D5A3',
                    },
                    fontFamily: {
                        sans: ['Quicksand', 'Poppins', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100dvh;
            overflow: hidden;
            font-family: 'Quicksand', 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #F9F7F2;
            touch-action: manipulation;
        }

        #app-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            background: #F9F7F2;
        }

        .safe-header {
            padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
            padding-bottom: 12px;
            background: #FFFDF5;
            border-bottom: 1px solid rgba(197, 160, 89, 0.15);
            position: sticky;
            top: 0;
            z-index: 50;
            flex-shrink: 0;
        }

        .header-gradient {
            background: linear-gradient(135deg, #F0EAD6 0%, #D4B896 100%);
            padding-top: calc(env(safe-area-inset-top, 0px) + 12px);
            padding-bottom: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            background: #F9F7F2;
            overflow: hidden;
            transition: opacity 0.3s ease;
        }

        .screen.hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }

        .screen.active {
            opacity: 1;
            pointer-events: auto;
            z-index: 1;
        }

        .screen-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 100px);
        }

        .login-screen {
            background: linear-gradient(135deg, #F0EAD6 0%, #D4B896 100%);
            justify-content: center;
            padding: 24px;
            z-index: 100;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #D4AF37 0%, #C5A059 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.4);
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            border-radius: 16px;
            border: 2px solid rgba(197, 160, 89, 0.3);
            background: white;
            font-size: 1rem;
            margin-bottom: 12px;
            outline: none;
            transition: all 0.3s ease;
        }

        .login-input:focus {
            border-color: #C5A059;
            box-shadow: 0 0 0 4px rgba(197, 160, 89, 0.15);
        }

        .login-btn {
            width: 100%;
            padding: 16px;
            border-radius: 50px;
            background: linear-gradient(135deg, #C5A059 0%, #D4B896 100%);
            color: white;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(197, 160, 89, 0.4);
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(197, 160, 89, 0.5);
        }

        .login-btn-secondary {
            width: 100%;
            padding: 14px;
            border-radius: 50px;
            background: transparent;
            color: #4B3621;
            font-weight: 500;
            font-size: 0.95rem;
            border: 2px solid rgba(197, 160, 89, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
        }

        .login-btn-secondary:hover {
            background: rgba(197, 160, 89, 0.1);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #FFFDF5;
            border-top: 1px solid rgba(197, 160, 89, 0.2);
            padding-bottom: env(safe-area-inset-bottom, 0px);
            z-index: 100;
            height: 80px;
            transition: transform 0.3s ease;
        }

        .bottom-nav.hidden {
            transform: translateY(100%);
        }

        .nav-container {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding-top: 8px;
            position: relative;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: color 0.2s ease;
            flex: 1;
        }

        .nav-item.active {
            color: #C5A059;
        }

        .nav-item:not(.active) {
            color: #8B7355;
        }

        .nav-center-btn {
            position: relative;
            top: -28px;
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, #D4AF37 0%, #C5A059 50%, #B8941F 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.5), 0 4px 16px rgba(197, 160, 89, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.3);
            border: 3px solid #FFFDF5;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            z-index: 10;
        }

        .nav-center-btn:active {
            transform: scale(0.95);
        }

        .nav-center-label {
            position: absolute;
            bottom: -22px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #C5A059;
            white-space: nowrap;
        }

        .stories-rail {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 12px 16px;
            background: #FFFDF5;
            border-bottom: 1px solid rgba(197, 160, 89, 0.1);
        }

        .stories-rail::-webkit-scrollbar {
            display: none;
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            cursor: pointer;
        }

        .story-avatar-ring {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, #F0EAD6, #C5A059, #D4B896);
        }

        .story-avatar-ring.unseen {
            background: linear-gradient(45deg, #D4AF37, #C5A059, #D4B896);
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(197, 160, 89, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(197, 160, 89, 0);
            }
        }

        .story-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #FFFDF5;
            object-fit: cover;
        }

        .camera-overlay {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 500;
            display: none;
            flex-direction: column;
        }

        .camera-overlay.active {
            display: flex;
        }

        .camera-preview {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-canvas {
            display: none;
        }

        .camera-controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 0 24px;
        }

        .camera-btn-capture {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: white;
            border: 4px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            position: relative;
            transition: transform 0.1s;
        }

        .camera-btn-capture:active {
            transform: scale(0.9);
        }

        .camera-btn-capture::after {
            content: '';
            position: absolute;
            inset: 4px;
            border-radius: 50%;
            background: white;
            border: 2px solid #C5A059;
        }

        .camera-btn-gallery {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid white;
        }

        .camera-btn-gallery img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-btn-close {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 20px);
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
        }

        .camera-mode-switch {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 20px);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 16px;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 16px;
            border-radius: 20px;
        }

        .camera-mode-btn {
            color: white;
            font-size: 14px;
            font-weight: 500;
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.6;
        }

        .camera-mode-btn.active {
            opacity: 1;
        }

        .post-editor-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 600;
            display: none;
            flex-direction: column;
        }

        .post-editor-modal.active {
            display: flex;
        }

        .post-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
        }

        .post-editor-preview {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .post-editor-preview img,
        .post-editor-preview video {
            max-width: 100%;
            max-height: 50vh;
            border-radius: 16px;
            object-fit: contain;
        }

        .post-editor-footer {
            padding: 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);
            background: #1a1a1a;
        }

        .post-editor-input {
            width: 100%;
            background: #2a2a2a;
            border: none;
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-size: 16px;
            resize: none;
            margin-bottom: 16px;
        }

        .post-editor-input::placeholder {
            color: #888;
        }

        .post-editor-submit {
            width: 100%;
            padding: 16px;
            border-radius: 50px;
            background: linear-gradient(135deg, #C5A059 0%, #D4B896 100%);
            color: white;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .story-canvas-editor {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 650;
            display: none;
            flex-direction: column;
        }

        .story-canvas-editor.active {
            display: flex;
        }

        .story-canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
            background: rgba(0, 0, 0, 0.8);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }

        .story-canvas-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        #story-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            touch-action: none;
        }

        .story-canvas-tools {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 16px 20px;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 20px);
            z-index: 20;
        }

        .story-tools-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .story-tool-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .story-tool-btn.active {
            background: rgba(197, 160, 89, 0.3);
            border-color: #C5A059;
        }

        .story-tool-btn svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        .story-colors-row {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .story-color-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .story-color-btn.active {
            border-color: white;
            transform: scale(1.1);
        }

        .story-text-input-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 30;
            display: none;
        }

        .story-text-input-container.active {
            display: block;
        }

        .story-text-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 32px;
            font-weight: 700;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            outline: none;
            min-width: 200px;
            padding: 8px;
        }

        .story-text-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .story-submit-btn {
            width: 100%;
            padding: 16px;
            border-radius: 50px;
            background: linear-gradient(135deg, #C5A059 0%, #D4B896 100%);
            color: white;
            font-weight: 700;
            font-size: 16px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .story-brush-size {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .story-brush-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-brush-btn.active {
            border-color: #C5A059;
        }

        .story-brush-dot {
            background: white;
            border-radius: 50%;
        }

        .story-viewer {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 700;
            display: none;
            flex-direction: column;
        }

        .story-viewer.active {
            display: flex;
        }

        .story-progress-container {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 12px);
            left: 12px;
            right: 12px;
            display: flex;
            gap: 4px;
            z-index: 10;
        }

        .story-progress-bar {
            flex: 1;
            height: 3px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .story-progress-fill {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 0.1s linear;
        }

        .story-progress-fill.active {
            animation: progress 10s linear forwards;
        }

        @keyframes progress {
            from {
                width: 0%;
            }

            to {
                width: 100%;
            }
        }

        .story-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .story-content img,
        .story-content video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .story-nav {
            position: absolute;
            inset: 0;
            display: flex;
        }

        .story-nav-prev,
        .story-nav-next {
            flex: 1;
            cursor: pointer;
        }

        .story-header {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 30px);
            left: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10;
        }

        .story-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        .story-user-info {
            color: white;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
        }

        .story-close {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 30px);
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            z-index: 10;
        }

        /* SOCIAL CARD CON ACCIONES */
        .social-card {
            background: #FFFDF5;
            border-radius: 24px;
            margin: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(75, 54, 33, 0.06);
        }

        .post-media {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            border-top: 1px solid rgba(197, 160, 89, 0.1);
        }

        .post-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: none;
        }

        .post-action-btn:hover {
            background: rgba(197, 160, 89, 0.1);
        }

        .post-action-btn svg {
            width: 24px;
            height: 24px;
            color: #8B7355;
            transition: all 0.2s;
        }

        .post-action-btn.liked svg {
            color: #EF4444;
            fill: #EF4444;
        }

        .post-action-btn.liked svg path {
            fill: #EF4444;
        }

        .post-action-count {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4B3621;
        }

        .post-caption {
            padding: 0 16px 16px;
        }

        .post-caption-text {
            font-size: 0.95rem;
            color: #4B3621;
        }

        .post-caption-text .username {
            font-weight: 700;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.4;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-bubble.bot {
            align-self: flex-start;
            background: #FFFDF5;
            color: #4B3621;
            border: 1px solid rgba(197, 160, 89, 0.2);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #C5A059 0%, #D4B896 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-input-area {
            padding: 12px 16px calc(env(safe-area-inset-bottom, 0px) + 80px);
            background: #FFFDF5;
            border-top: 1px solid rgba(197, 160, 89, 0.15);
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #F9F7F2;
            border-radius: 50px;
            padding: 4px 4px 4px 16px;
            border: 1px solid rgba(197, 160, 89, 0.2);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 0.95rem;
            color: #4B3621;
            outline: none;
            padding: 10px 0;
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #C5A059 0%, #D4B896 100%);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .product-card {
            background: #FFFDF5;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(75, 54, 33, 0.05);
        }

        .category-pill {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
        }

        .category-pill.active {
            background: #C5A059;
            color: white;
        }

        .category-pill:not(.active) {
            background: #FFFDF5;
            color: #6D5D4E;
            border: 1px solid rgba(197, 160, 89, 0.2);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .grooming-header {
            background: linear-gradient(135deg, #FFFDF5 0%, #F5EFE0 100%);
            border-bottom: 1px solid rgba(197, 160, 89, 0.2);
        }

        .announcement-card {
            background: #FFFDF5;
            border: 1px solid rgba(197, 160, 89, 0.25);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .portfolio-ring {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(135deg, #D4AF37, #C5A059, #D4B896);
        }

        .portfolio-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 3px solid #FFFDF5;
            object-fit: cover;
        }

        .cta-button {
            background: linear-gradient(135deg, #C5A059 0%, #D4B896 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 4px 16px rgba(197, 160, 89, 0.4);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .cta-button-gold {
            background: linear-gradient(135deg, #D4AF37 0%, #C5A059 50%, #B8941F 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 8px 32px rgba(212, 175, 55, 0.5);
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            width: 100%;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(249, 247, 242, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #F0EAD6;
            border-top: 4px solid #C5A059;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 2000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: #22c55e;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.info {
            background: #3b82f6;
        }

        .header-centered {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 12px 16px;
            padding-top: calc(env(safe-area-inset-top, 0px) + 12px);
        }

        .header-centered .header-title {
            text-align: center;
        }

        .header-centered .header-actions {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            margin-top: calc(env(safe-area-inset-top, 0px) / 2);
        }

        /* PERFIL */
        .profile-header-new {
            background: linear-gradient(135deg, #F0EAD6 0%, #D4B896 100%);
            padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
            padding-bottom: 24px;
            position: relative;
        }

        .profile-header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 16px 16px;
        }

        .profile-avatar-large {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            object-fit: cover;
        }

        .profile-header-actions {
            display: flex;
            gap: 12px;
        }

        .profile-icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            position: relative;
        }

        .profile-icon-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .profile-icon-btn .badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 18px;
            height: 18px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-info {
            text-align: center;
            padding: 0 16px;
        }

        .profile-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #4B3621;
            margin-bottom: 4px;
        }

        .profile-pet-name {
            font-size: 0.9rem;
            color: #6D5D4E;
        }

        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            padding: 16px 0;
        }

        .profile-stat {
            text-align: center;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .profile-stat:hover {
            opacity: 0.8;
        }

        .profile-stat.active .stat-value {
            color: #C5A059;
        }

        .profile-stat .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #4B3621;
            transition: color 0.2s;
        }

        .profile-stat .stat-label {
            font-size: 0.75rem;
            color: #8B7355;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid rgba(197, 160, 89, 0.2);
            background: white;
        }

        .profile-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
            color: #8B7355;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .profile-tab.active {
            color: #C5A059;
            border-bottom-color: #C5A059;
        }

        .profile-content {
            padding: 16px;
            min-height: 300px;
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }

        .posts-grid-item {
            aspect-ratio: 1;
            overflow: hidden;
            cursor: pointer;
        }

        .posts-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.2s;
        }

        .posts-grid-item:hover img {
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #8B7355;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .booking-item {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid rgba(197, 160, 89, 0.15);
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .booking-service {
            font-weight: 600;
            color: #4B3621;
        }

        .booking-status {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .booking-status.pendiente {
            background: #FEF3C7;
            color: #92400E;
        }

        .booking-status.confirmada {
            background: #D1FAE5;
            color: #065F46;
        }

        .booking-status.completada {
            background: #E5E7EB;
            color: #374151;
        }

        .booking-date {
            font-size: 0.85rem;
            color: #6D5D4E;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pet-form {
            background: white;
            border-radius: 16px;
            padding: 20px;
        }

        .pet-form-group {
            margin-bottom: 16px;
        }

        .pet-form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: #4B3621;
            margin-bottom: 6px;
        }

        .pet-form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s;
        }

        .pet-form-input:focus {
            border-color: #C5A059;
            box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
        }

        .pet-form-input:read-only {
            background: #F9F7F2;
            color: #8B7355;
        }

        .pet-avatar-upload {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px dashed rgba(197, 160, 89, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 auto 20px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .pet-avatar-upload:hover {
            border-color: #C5A059;
            background: rgba(197, 160, 89, 0.05);
        }

        .pet-avatar-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pet-avatar-upload .upload-icon {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px;
            text-align: center;
        }

        .pet-avatar-upload .upload-icon svg {
            width: 16px;
            height: 16px;
            color: white;
        }

        /* Side Menu Modal */
        .side-menu-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 800;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .side-menu-overlay.active {
            display: block;
            opacity: 1;
        }

        .side-menu {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 80%;
            max-width: 320px;
            background: white;
            z-index: 801;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding-top: calc(env(safe-area-inset-top, 0px) + 16px);
        }

        .side-menu.active {
            transform: translateX(0);
        }

        .side-menu-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(197, 160, 89, 0.15);
        }

        .side-menu-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4B3621;
        }

        .side-menu-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid rgba(197, 160, 89, 0.08);
        }

        .side-menu-item:hover {
            background: rgba(197, 160, 89, 0.05);
        }

        .side-menu-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .side-menu-item-icon.blue {
            background: #EFF6FF;
            color: #3B82F6;
        }

        .side-menu-item-icon.green {
            background: #ECFDF5;
            color: #10B981;
        }

        .side-menu-item-icon.purple {
            background: #F3E8FF;
            color: #8B5CF6;
        }

        .side-menu-item-icon.orange {
            background: #FFF7ED;
            color: #F97316;
        }

        .side-menu-item-icon.red {
            background: #FEF2F2;
            color: #EF4444;
        }

        .side-menu-item-text {
            flex: 1;
        }

        .side-menu-item-title {
            font-weight: 600;
            color: #4B3621;
            font-size: 0.95rem;
        }

        .side-menu-item-desc {
            font-size: 0.8rem;
            color: #8B7355;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 900;
            display: none;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-sheet {
            background: white;
            width: 100%;
            max-height: 90vh;
            border-radius: 24px 24px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .modal-overlay.active .modal-sheet {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(197, 160, 89, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4B3621;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: #F9F7F2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: #4B3621;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(197, 160, 89, 0.3);
            border-radius: 12px;
            font-size: 0.95rem;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: #C5A059;
            box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.1);
        }

        .form-input:read-only {
            background: #F9F7F2;
            color: #8B7355;
        }

        .avatar-edit {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
            cursor: pointer;
        }

        .avatar-edit img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .avatar-edit-overlay {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .avatar-edit:hover .avatar-edit-overlay {
            opacity: 1;
        }

        .avatar-edit-overlay svg {
            width: 24px;
            height: 24px;
            color: white;
        }

        /* Wizard */
        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .wizard-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .wizard-progress-bar {
            flex: 1;
            height: 4px;
            background: #E5E7EB;
            border-radius: 2px;
            overflow: hidden;
        }

        .wizard-progress-bar.fill {
            background: #C5A059;
        }

        .option-card {
            padding: 16px;
            border: 2px solid rgba(197, 160, 89, 0.2);
            border-radius: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-card:hover {
            border-color: rgba(197, 160, 89, 0.5);
        }

        .option-card.selected {
            border-color: #C5A059;
            background: rgba(197, 160, 89, 0.05);
        }

        .option-card-title {
            font-weight: 600;
            color: #4B3621;
        }

        .wizard-nav {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .wizard-btn {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .wizard-btn.secondary {
            background: #F3F4F6;
            color: #4B3621;
        }

        .wizard-btn.secondary:hover {
            background: #E5E7EB;
        }

        .wizard-btn.primary {
            background: linear-gradient(135deg, #C5A059 0%, #D4B896 100%);
            color: white;
        }

        .wizard-btn.primary:hover {
            opacity: 0.9;
        }

        .wizard-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Notificaciones */
        .notification-item {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid rgba(197, 160, 89, 0.1);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: rgba(197, 160, 89, 0.03);
        }

        .notification-item.unread {
            background: rgba(197, 160, 89, 0.05);
        }

        .notification-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-text {
            font-size: 0.9rem;
            color: #4B3621;
            line-height: 1.4;
        }

        .notification-text strong {
            font-weight: 600;
        }

        .notification-time {
            font-size: 0.75rem;
            color: #8B7355;
            margin-top: 4px;
        }

        .notification-dot {
            width: 8px;
            height: 8px;
            background: #C5A059;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
        }

        /* Alerta */
        .alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .alert-overlay.active {
            display: flex;
        }

        .alert-box {
            background: white;
            border-radius: 20px;
            padding: 24px;
            max-width: 320px;
            width: 100%;
            text-align: center;
            animation: scaleIn 0.2s;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .alert-icon {
            width: 56px;
            height: 56px;
            background: #FEF2F2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .alert-icon svg {
            width: 28px;
            height: 28px;
            color: #EF4444;
        }

        .alert-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4B3621;
            margin-bottom: 8px;
        }

        .alert-message {
            font-size: 0.9rem;
            color: #6D5D4E;
            margin-bottom: 20px;
        }

        .alert-buttons {
            display: flex;
            gap: 12px;
        }

        .alert-btn {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .alert-btn.cancel {
            background: #F3F4F6;
            color: #4B3621;
        }

        .alert-btn.confirm {
            background: #EF4444;
            color: white;
        }
    </style>
</head>

<body>
    <div id="app-container">
        <!-- SCREEN: LOGIN -->
        <div id="screen-login" class="screen login-screen active">
            <div class="text-center mb-8">
                <div class="login-logo">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-[#4B3621] font-serif mb-2">Maria's Cut</h1>
                <p class="text-[#6D5D4E]">Peluqueria Canina Premium</p>
            </div>
            <div class="space-y-3">
                <input type="email" id="login-email" class="login-input" placeholder="Correo electronico">
                <input type="password" id="login-password" class="login-input" placeholder="Contrasena">
                <div id="register-fields" class="hidden space-y-3">
                    <input type="text" id="login-name" class="login-input" placeholder="Tu nombre">
                    <input type="text" id="login-pet" class="login-input" placeholder="Nombre de tu mascota">
                    <input type="tel" id="login-phone" class="login-input" placeholder="Telefono">
                </div>
                <div id="login-actions">
                    <button id="btn-login" class="login-btn">Iniciar Sesion</button>
                    <button id="btn-show-register" class="login-btn-secondary text-sm mt-2">No tienes cuenta? Registrate
                        aqui</button>
                </div>
                <div id="register-actions" class="hidden">
                    <button id="btn-register" class="login-btn">Registrarse</button>
                    <button id="btn-show-login" class="login-btn-secondary text-sm mt-2">Ya tienes cuenta? Inicia
                        Sesion</button>
                </div>
                <button id="btn-skip"
                    class="text-[#8B7355] text-xs font-semibold mt-6 underline hover:text-[#4B3621] transition-colors">Entrar
                    como Invitado</button>
            </div>
            <p id="login-error" class="text-red-600 text-sm text-center mt-4 hidden bg-white/80 p-2 rounded-lg"></p>
        </div>
    </div>

    <!-- SCREEN: HOME (SOCIAL CLUB) -->
    <div id="screen-home" class="screen hidden">
        <div class="header-gradient header-centered">
            <div class="header-title">
                <h1 class="text-lg font-bold text-[#4B3621]">Maria's Social Club</h1>
                <p class="text-xs text-[#C5A059] font-medium">Comunidad Exclusiva</p>
            </div>
            <div class="header-actions">
                <button id="btn-add-content"
                    class="w-9 h-9 bg-white/50 rounded-full flex items-center justify-center hover:bg-white/70 transition-colors">
                    <svg class="w-5 h-5 text-[#4B3621]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="screen-content">
            <div class="stories-rail" id="stories-container"></div>
            <div id="feed-container"></div>
        </div>
    </div>

    <!-- SCREEN: SHOP -->
    <div id="screen-shop" class="screen hidden">
        <div class="safe-header px-4 flex justify-between items-center">
            <h1 class="text-lg font-bold text-[#4B3621]">Boutique Maria's Cut</h1>
            <div class="relative">
                <svg class="w-6 h-6 text-[#4B3621]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                </svg>
                <span
                    class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center font-bold">2</span>
            </div>
        </div>
        <div class="screen-content">
            <div class="px-4 py-3">
                <div class="relative">
                    <input type="text" placeholder="Buscar productos..."
                        class="w-full bg-[#FFFDF5] border border-[rgba(197,160,89,0.2)] rounded-xl py-3 pl-10 pr-4 text-sm focus:outline-none focus:border-[#C5A059]">
                    <svg class="w-5 h-5 text-[#8B7355] absolute left-3 top-3" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
            </div>
            <div class="flex gap-2 px-4 pb-3 overflow-x-auto no-scrollbar">
                <button class="category-pill active">Todo</button>
                <button class="category-pill">Alimentacion</button>
                <button class="category-pill">Juguetes</button>
                <button class="category-pill">Higiene</button>
                <button class="category-pill">Accesorios</button>
            </div>
            <div class="grid grid-cols-2 gap-3 px-4 pb-4">
                <div class="product-card">
                    <div class="aspect-square bg-[#F0EAD6] overflow-hidden">
                        <img src="https://images.unsplash.com/photo-1589924691195-41432c84c161?w=400&h=400&fit=crop"
                            class="w-full h-full object-cover">
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium text-[#4B3621]">Perrarina Premium</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[#C5A059] font-bold">$54.99</span>
                            <button
                                class="w-7 h-7 bg-[#F0EAD6] rounded-full flex items-center justify-center text-[#4B3621]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="aspect-square bg-[#F0EAD6] overflow-hidden">
                        <img src="https://images.unsplash.com/photo-1576201836106-db1758fd1c97?w=400&h=400&fit=crop"
                            class="w-full h-full object-cover">
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium text-[#4B3621]">Collar GPS</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[#C5A059] font-bold">$129.99</span>
                            <button
                                class="w-7 h-7 bg-[#F0EAD6] rounded-full flex items-center justify-center text-[#4B3621]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="aspect-square bg-[#F0EAD6] overflow-hidden">
                        <img src="https://images.unsplash.com/photo-1541599540903-216a46ca1dc0?w=400&h=400&fit=crop"
                            class="w-full h-full object-cover">
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium text-[#4B3621]">Juguete Resistente</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[#C5A059] font-bold">$24.50</span>
                            <button
                                class="w-7 h-7 bg-[#F0EAD6] rounded-full flex items-center justify-center text-[#4B3621]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="product-card">
                    <div class="aspect-square bg-[#F0EAD6] overflow-hidden">
                        <img src="https://images.unsplash.com/photo-1516734212186-a967f81ad0d7?w=400&h=400&fit=crop"
                            class="w-full h-full object-cover">
                    </div>
                    <div class="p-3">
                        <h3 class="text-sm font-medium text-[#4B3621]">Champu Organico</h3>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[#C5A059] font-bold">$18.90</span>
                            <button
                                class="w-7 h-7 bg-[#F0EAD6] rounded-full flex items-center justify-center text-[#4B3621]">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN: GROOMING -->
    <div id="screen-grooming" class="screen hidden">
        <div class="safe-header grooming-header px-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-[#4B3621] font-serif">El Studio de Maria</h1>
                <p class="text-xs text-[#C5A059] font-medium">Peluqueria Canina Premium</p>
            </div>
            <button id="btn-booking" class="cta-button flex items-center gap-2 text-sm">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Agendar Cita
            </button>
        </div>
        <div class="screen-content">
            <div class="bg-white py-4">
                <div class="px-4 mb-3">
                    <h2 class="text-sm font-bold text-[#4B3621] uppercase tracking-wide">Trabajos Recientes</h2>
                </div>
                <div class="flex overflow-x-auto gap-4 px-4 pb-2 no-scrollbar">
                    <div class="flex flex-col items-center flex-shrink-0">
                        <div class="portfolio-ring"><img
                                src="https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=200&h=200&fit=crop"
                                class="portfolio-avatar"></div>
                        <span class="text-xs text-[#4B3621] mt-2 font-medium">Luna</span>
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0">
                        <div class="portfolio-ring"><img
                                src="https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=200&h=200&fit=crop"
                                class="portfolio-avatar"></div>
                        <span class="text-xs text-[#4B3621] mt-2 font-medium">Max</span>
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0">
                        <div class="portfolio-ring"><img
                                src="https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?w=200&h=200&fit=crop"
                                class="portfolio-avatar"></div>
                        <span class="text-xs text-[#4B3621] mt-2 font-medium">Bella</span>
                    </div>
                    <div class="flex flex-col items-center flex-shrink-0">
                        <div class="portfolio-ring"><img
                                src="https://images.unsplash.com/photo-1583511655857-d19b40a7a54e?w=200&h=200&fit=crop"
                                class="portfolio-avatar"></div>
                        <span class="text-xs text-[#4B3621] mt-2 font-medium">Rocky</span>
                    </div>
                </div>
            </div>
            <div class="px-4 py-6">
                <div class="flex items-center gap-2 mb-4">
                    <div
                        class="w-8 h-8 bg-gradient-to-br from-[#C5A059] to-[#D4B896] rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z" />
                        </svg>
                    </div>
                    <h2 class="text-lg font-bold text-[#4B3621]">Avisos de Maria</h2>
                </div>
                <div class="announcement-card">
                    <div class="flex items-start gap-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-[#C5A059] to-[#D4B896] rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white font-bold text-sm">M</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1"><span
                                    class="font-bold text-[#4B3621]">Maria</span><span class="text-xs text-[#8B7355]">-
                                    Hace 2 horas</span></div>
                            <p class="text-[#4B3621] text-sm leading-relaxed"> <span
                                    class="font-semibold">Atencion!</span> La proxima semana tenemos <span
                                    class="text-[#C5A059] font-semibold">10% de descuento</span> en Banos Medicados. 
                            </p>
                        </div>
                    </div>
                </div>
                <div class="announcement-card">
                    <div class="flex items-start gap-3">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-[#C5A059] to-[#D4B896] rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-white font-bold text-sm">M</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1"><span
                                    class="font-bold text-[#4B3621]">Maria</span><span class="text-xs text-[#8B7355]">-
                                    Ayer</span></div>
                            <p class="text-[#4B3621] text-sm leading-relaxed"> Nuestra Furgoneta Luna estara en <span
                                    class="font-semibold">Las Condes</span> este viernes. Cupos limitados!</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="px-4 pb-6">
                <h2 class="text-sm font-bold text-[#4B3621] uppercase tracking-wide mb-4">Nuestros Servicios</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white rounded-2xl p-4 border border-[rgba(197,160,89,0.2)]">
                        <div class="w-10 h-10 bg-[#F0EAD6] rounded-xl flex items-center justify-center mb-3">
                            <svg class="w-5 h-5 text-[#C5A059]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
                            </svg>
                        </div>
                        <h3 class="font-semibold text-[#4B3621] text-sm">Bano & Corte</h3>
                        <p class="text-xs text-[#8B7355] mt-1">Desde $35.000</p>
                    </div>
                    <div class="bg-white rounded-2xl p-4 border border-[rgba(197,160,89,0.2)]">
                        <div class="w-10 h-10 bg-[#F0EAD6] rounded-xl flex items-center justify-center mb-3">
                            <svg class="w-5 h-5 text-[#C5A059]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                        </div>
                        <h3 class="font-semibold text-[#4B3621] text-sm">Spa Deluxe</h3>
                        <p class="text-xs text-[#8B7355] mt-1">Desde $55.000</p>
                    </div>
                    <div class="bg-white rounded-2xl p-4 border border-[rgba(197,160,89,0.2)]">
                        <div class="w-10 h-10 bg-[#F0EAD6] rounded-xl flex items-center justify-center mb-3">
                            <svg class="w-5 h-5 text-[#C5A059]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                                <path stroke-linecap="round" strokelinejoin="round" stroke-width="2"
                                    d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                            </svg>
                        </div>
                        <h3 class="font-semibold text-[#4B3621] text-sm">A Domicilio</h3>
                        <p class="text-xs text-[#8B7355] mt-1">Furgoneta VIP</p>
                    </div>
                    <div class="bg-white rounded-2xl p-4 border border-[rgba(197,160,89,0.2)]">
                        <div class="w-10 h-10 bg-[#F0EAD6] rounded-xl flex items-center justify-center mb-3">
                            <svg class="w-5 h-5 text-[#C5A059]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </div>
                        <h3 class="font-semibold text-[#4B3621] text-sm">Tratamientos</h3>
                        <p class="text-xs text-[#8B7355] mt-1">Piel & Pelo</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCREEN: ASSISTANT -->
    <div id="screen-assistant" class="screen hidden">
        <div class="safe-header px-4">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-gradient-to-br from-[#C5A059] to-[#D4B896] rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-[#4B3621]">Asistente Maria's Cut</h1>
                    <p class="text-xs text-[#C5A059]">Experto en bienestar animal</p>
                </div>
            </div>
        </div>
        <div class="chat-container">
            <div id="chat-messages" class="chat-messages">
                <div class="chat-bubble bot">Hola, soy la IA de Maria's Cut. En que puedo ayudarte hoy con tu mascota?
                    </div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-input" class="chat-input" placeholder="Escribe tu mensaje...">
                    <button id="btn-send-chat" class="chat-send-btn">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<!-- SCREEN: PROFILE -->
<div id="screen-profile" class="screen hidden">
    <div class="profile-header-new">
        <div class="profile-header-top">
            <div style="width: 40px;"></div>
            <div class="relative">
                <img id="profile-avatar"
                    src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop"
                    class="profile-avatar-large">
            </div>
            <div class="profile-header-actions">
                <button id="btn-notifications" class="profile-icon-btn relative">
                    <svg class="w-5 h-5 text-[#4B3621]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                    </svg>
                    <span id="notif-badge" class="badge">3</span>
                </button>
                <button id="btn-menu" class="profile-icon-btn">
                    <svg class="w-5 h-5 text-[#4B3621]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="profile-info">
            <h1 id="profile-name" class="profile-name">Cargando...</h1>
            <p id="profile-pet" class="profile-pet-name">...</p>
        </div>
    </div>

    <div class="profile-stats">
        <div class="profile-stat" data-tab="mascota">
            <p id="stat-mascotas" class="stat-value">1</p>
            <p class="stat-label">Mascota</p>
        </div>
        <div class="profile-stat" data-tab="citas">
            <p id="stat-citas" class="stat-value">0</p>
            <p class="stat-label">Citas</p>
        </div>
        <div class="profile-stat active" data-tab="posts">
            <p id="stat-posts" class="stat-value">0</p>
            <p class="stat-label">Posts</p>
        </div>
    </div>

    <div class="profile-tabs">
        <div class="profile-tab" data-tab="mascota">Mascota</div>
        <div class="profile-tab" data-tab="citas">Citas</div>
        <div class="profile-tab active" data-tab="posts">Posts</div>
    </div>

    <div class="screen-content">
        <div id="tab-content-posts" class="profile-content">
            <div id="user-posts-grid" class="posts-grid"></div>
            <div id="posts-empty" class="empty-state hidden">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p>Aun no has publicado nada</p>
                <p class="text-sm mt-2">Comparte fotos de tu mascota!</p>
            </div>
        </div>

        <div id="tab-content-citas" class="profile-content hidden">
            <div id="user-bookings-list"></div>
            <div id="bookings-empty" class="empty-state">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p>No tienes citas programadas</p>
                <p class="text-sm mt-2">Agenda tu primera visita</p>
            </div>
        </div>

        <div id="tab-content-mascota" class="profile-content hidden">
            <div class="pet-form">
                <div class="pet-avatar-upload" id="pet-avatar-upload">
                    <img id="pet-avatar-img"
                        src="https://images.unsplash.com/photo-1543466835-00a7907e9de1?w=200&h=200&fit=crop"
                        alt="Mascota">
                    <div class="upload-icon">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </div>
                </div>
                <input type="file" id="pet-avatar-input" class="hidden" accept="image/*">

                <div class="pet-form-group">
                    <label class="pet-form-label">Nombre de la mascota</label>
                    <input type="text" id="pet-name-input" class="pet-form-input" placeholder="Ej: Luna">
                </div>
                <div class="pet-form-group">
                    <label class="pet-form-label">Raza</label>
                    <input type="text" id="pet-breed-input" class="pet-form-input" placeholder="Ej: Golden Retriever">
                </div>
                <div class="pet-form-group">
                    <label class="pet-form-label">Edad</label>
                    <input type="text" id="pet-age-input" class="pet-form-input" placeholder="Ej: 2 anos">
                </div>
                <div class="pet-form-group">
                    <label class="pet-form-label">Notas especiales</label>
                    <input type="text" id="pet-notes-input" class="pet-form-input"
                        placeholder="Alergias, cuidados especiales...">
                </div>
                <button id="btn-save-pet" class="login-btn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- SIDE MENU -->
<div id="side-menu-overlay" class="side-menu-overlay"></div>
<div id="side-menu" class="side-menu">
    <div class="side-menu-header">
        <h3 class="side-menu-title">Ajustes</h3>
    </div>
    <div class="side-menu-item" id="menu-mis-datos">
        <div class="side-menu-item-icon blue">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
        </div>
        <div class="side-menu-item-text">
            <div class="side-menu-item-title">Mis Datos</div>
            <div class="side-menu-item-desc">Editar perfil y contrasena</div>
        </div>
    </div>
    <div class="side-menu-item" id="menu-entrenador">
        <div class="side-menu-item-icon green">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
        </div>
        <div class="side-menu-item-text">
            <div class="side-menu-item-title">Hacerme Entrenador</div>
            <div class="side-menu-item-desc">Aplica para ser entrenador certificado</div>
        </div>
    </div>
    <div class="side-menu-item" id="menu-paseador">
        <div class="side-menu-item-icon purple">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </div>
        <div class="side-menu-item-text">
            <div class="side-menu-item-title">Hacerme Paseador</div>
            <div class="side-menu-item-desc">Ofrece tus servicios de paseo</div>
        </div>
    </div>
    <div class="side-menu-item" id="menu-logout">
        <div class="side-menu-item-icon red">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        </div>
        <div class="side-menu-item-text">
            <div class="side-menu-item-title">Cerrar Sesion</div>
            <div class="side-menu-item-desc">Salir de tu cuenta</div>
        </div>
    </div>
</div>

<!-- MODAL: MIS DATOS -->
<div id="modal-mis-datos" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header">
            <h3 class="modal-title">Mis Datos</h3>
            <button class="modal-close" onclick="closeModal('modal-mis-datos')">
                <svg class="w-5 h-5 text-[#8B7355]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="avatar-edit" id="avatar-edit">
                <img id="modal-avatar-img"
                    src="https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop">
                <div class="avatar-edit-overlay">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </div>
            </div>
            <input type="file" id="avatar-input" class="hidden" accept="image/*">

            <div class="form-group">
                <label class="form-label">Nombre</label>
                <input type="text" id="edit-name" class="form-input" placeholder="Tu nombre">
            </div>
            <div class="form-group">
                <label class="form-label">Telefono</label>
                <input type="tel" id="edit-phone" class="form-input" placeholder="+56 9 1234 5678">
            </div>
            <div class="form-group">
                <label class="form-label">Correo electronico</label>
                <input type="email" id="edit-email" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Cambiar contrasena</label>
                <input type="password" id="edit-password" class="form-input" placeholder="Nueva contrasena (opcional)">
            </div>
            <button id="btn-save-datos" class="login-btn">Guardar Cambios</button>
        </div>
    </div>
</div>

<!-- MODAL: WIZARD -->
<div id="modal-wizard" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header">
            <h3 class="modal-title" id="wizard-title">Solicitud de Entrenador</h3>
            <button class="modal-close" onclick="closeModal('modal-wizard')">
                <svg class="w-5 h-5 text-[#8B7355]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="wizard-progress">
                <div class="wizard-progress-bar fill" id="progress-1"></div>
                <div class="wizard-progress-bar" id="progress-2"></div>
                <div class="wizard-progress-bar" id="progress-3"></div>
                <div class="wizard-progress-bar" id="progress-4"></div>
                <div class="wizard-progress-bar" id="progress-5"></div>
            </div>

            <div class="wizard-step active" id="step-1">
                <h4 class="text-lg font-semibold text-[#4B3621] mb-4">Cuantos anos de experiencia tienes?</h4>
                <div class="option-card" data-value="0-1">
                    <div class="option-card-title">0 - 1 ano</div>
                </div>
                <div class="option-card" data-value="2-5">
                    <div class="option-card-title">2 - 5 anos</div>
                </div>
                <div class="option-card" data-value="+5">
                    <div class="option-card-title">Mas de 5 anos</div>
                </div>
                <div class="option-card" data-value="otro">
                    <div class="option-card-title">Otro</div>
                </div>
            </div>

            <div class="wizard-step" id="step-2">
                <h4 class="text-lg font-semibold text-[#4B3621] mb-4">Tienes certificacion profesional?</h4>
                <div class="option-card" data-value="si-certificado">
                    <div class="option-card-title">Si, tengo certificacion</div>
                </div>
                <div class="option-card" data-value="en-proceso">
                    <div class="option-card-title">Estoy en proceso de certificarme</div>
                </div>
                <div class="option-card" data-value="autodidacta">
                    <div class="option-card-title">Soy autodidacta</div>
                </div>
                <div class="option-card" data-value="no-tengo">
                    <div class="option-card-title">No tengo certificacion</div>
                </div>
            </div>

            <div class="wizard-step" id="step-3">
                <h4 class="text-lg font-semibold text-[#4B3621] mb-4">Que tipo de mascotas prefieres trabajar?</h4>
                <div class="option-card" data-value="perros">
                    <div class="option-card-title">Perros</div>
                </div>
                <div class="option-card" data-value="gatos">
                    <div class="option-card-title">Gatos</div>
                </div>
                <div class="option-card" data-value="ambos">
                    <div class="option-card-title">Ambos</div>
                </div>
                <div class="option-card" data-value="otros-animales">
                    <div class="option-card-title">Otros animales</div>
                </div>
            </div>

            <div class="wizard-step" id="step-4">
                <h4 class="text-lg font-semibold text-[#4B3621] mb-4">Disponibilidad de tiempo?</h4>
                <div class="option-card" data-value="tiempo-completo">
                    <div class="option-card-title">Tiempo completo</div>
                </div>
                <div class="option-card" data-value="medio-tiempo">
                    <div class="option-card-title">Medio tiempo</div>
                </div>
                <div class="option-card" data-value="fines-semana">
                    <div class="option-card-title">Solo fines de semana</div>
                </div>
                <div class="option-card" data-value="por-horas">
                    <div class="option-card-title">Por horas</div>
                </div>
            </div>

            <div class="wizard-step" id="step-5">
                <h4 class="text-lg font-semibold text-[#4B3621] mb-4">Cuntanos sobre ti</h4>
                <textarea id="wizard-about" class="post-editor-input" rows="5"
                    placeholder="Describe tu experiencia, metodologia, o cualquier informacion relevante..."></textarea>
            </div>

            <div class="wizard-nav">
                <button class="wizard-btn secondary" id="wizard-prev" onclick="prevWizardStep()">Anterior</button>
                <button class="wizard-btn primary" id="wizard-next" onclick="nextWizardStep()">Siguiente</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: NOTIFICACIONES -->
<div id="modal-notifications" class="modal-overlay">
    <div class="modal-sheet">
        <div class="modal-header">
            <h3 class="modal-title">Notificaciones</h3>
            <button class="modal-close" onclick="closeModal('modal-notifications')">
                <svg class="w-5 h-5 text-[#8B7355]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="modal-body" id="notifications-list"></div>
    </div>
</div>

<!-- ALERT: LOGOUT -->
<div id="alert-logout" class="alert-overlay">
    <div class="alert-box">
        <div class="alert-icon">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        </div>
        <h4 class="alert-title">Cerrar sesion?</h4>
        <p class="alert-message">Estas seguro de que deseas salir de tu cuenta?</p>
        <div class="alert-buttons">
            <button class="alert-btn cancel" onclick="closeAlert('alert-logout')">Cancelar</button>
            <button class="alert-btn confirm" id="confirm-logout">Cerrar Sesion</button>
        </div>
    </div>
</div>

<!-- SCREEN: BOOKING -->
<div id="screen-booking" class="screen hidden">
    <div class="safe-header border-b border-gray-100 pb-4 px-5 flex items-center">
        <button id="btn-back-grooming" class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors">
            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <h1 class="text-lg font-semibold text-gray-800 ml-2">Reserva en Local</h1>
    </div>
    <div class="screen-content px-5 pt-6">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Selecciona un servicio</h2>
        <div class="bg-white rounded-2xl shadow-md p-4 border-2 border-[#C5A059] cursor-pointer mb-6" id="select-spa">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-semibold text-gray-800 text-lg">Spa Deluxe</h3>
                    <p class="text-gray-500 text-sm mt-1">Hidromasaje + Aromaterapia</p>
                    <div class="flex items-center mt-2 text-gray-400 text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>90 min
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xl font-bold text-[#C5A059]">$55.000</p>
                    <span class="bg-[#C5A059]/10 text-[#C5A059] text-xs px-2 py-1 rounded-full font-bold">Popular</span>
                </div>
            </div>
        </div>
        <button id="btn-continue-payment"
            class="btn-ripple w-full bg-[#C5A059] hover:bg-[#A88B45] text-white font-semibold py-4 rounded-2xl transition-colors shadow-lg">Continuar
            al Pago</button>
    </div>
</div>

<!-- SCREEN: PAYMENT -->
<div id="screen-payment" class="screen hidden">
    <div class="safe-header border-b border-gray-100 pb-4 px-5 flex items-center">
        <button id="btn-back-booking" class="p-2 -ml-2 rounded-full hover:bg-gray-100 transition-colors">
            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <h1 class="text-lg font-semibold text-gray-800 ml-2">Confirmar y Pagar</h1>
    </div>
    <div class="screen-content px-5 pt-6">
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 bg-[#F0EAD6] rounded-xl flex items-center justify-center">
                    <svg class="w-8 h-8 text-[#C5A059]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
                    </svg>
                </div>
                <div>
                    <h3 class="font-bold text-gray-800 text-lg">Spa Deluxe</h3>
                    <p class="text-gray-500 text-sm">Servicio Premium</p>
                </div>
            </div>
            <div class="border-t border-gray-100 pt-4">
                <div class="flex justify-between mb-2"><span class="text-gray-600">Subtotal</span><span
                        class="font-medium">$55.000</span></div>
                <div class="flex justify-between mb-2"><span class="text-gray-600">IVA (19%)</span><span
                        class="font-medium">$10.450</span></div>
                <div class="flex justify-between pt-2 border-t border-gray-100"><span
                        class="font-bold text-gray-800">Total</span><span
                        class="font-bold text-[#C5A059] text-xl">$65.450</span></div>
            </div>
        </div>
        <button id="btn-stripe-pay" class="cta-button-gold flex items-center justify-center gap-3">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            Pagar Ahora y Confirmar
        </button>
    </div>
</div>

<!-- BOTTOM NAVIGATION -->
<nav id="bottom-nav" class="bottom-nav hidden">
    <div class="nav-container">
        <div class="nav-item" data-screen="screen-home">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path
                    d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" />
            </svg>
            <span class="text-xs mt-1">Club</span>
        </div>
        <div class="nav-item" data-screen="screen-shop">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <span class="text-xs mt-1">Tienda</span>
        </div>
        <div class="nav-center-btn" data-screen="screen-grooming">
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M14.121 14.121L19 19m-7-7l7-7m-7 7l-2.879 2.879M12 12L9.121 9.121m0 5.758a3 3 0 10-4.243 4.243 3 3 0 004.243-4.243zm0-5.758a3 3 0 10-4.243-4.243 3 3 0 004.243 4.243z" />
            </svg>
            <span class="nav-center-label">Peluqueria</span>
        </div>
        <div class="nav-item" data-screen="screen-assistant">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span class="text-xs mt-1">Asistente</span>
        </div>
        <div class="nav-item" data-screen="screen-profile">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span class="text-xs mt-1">Perfil</span>
        </div>
    </div>
</nav>

<!-- CAMERA OVERLAY -->
<div id="camera-overlay" class="camera-overlay">
    <div class="camera-preview">
        <video id="camera-video" class="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas" class="camera-canvas"></canvas>
        <button id="camera-close" class="camera-btn-close">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <div class="camera-mode-switch">
            <button class="camera-mode-btn active" data-mode="story">Historia</button>
            <button class="camera-mode-btn" data-mode="post">Publicacion</button>
        </div>
    </div>
    <div class="camera-controls">
        <div class="camera-btn-gallery" id="camera-gallery-btn">
            <img src="https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=100&h=100&fit=crop" alt="Gallery">
        </div>
        <button id="camera-capture" class="camera-btn-capture"></button>
        <div style="width: 50px;"></div>
    </div>
</div>

<!-- POST EDITOR MODAL -->
<div id="post-editor-modal" class="post-editor-modal">
    <div class="post-editor-header">
        <button id="editor-cancel" class="text-white font-medium">Cancelar</button>
        <span id="editor-title" class="text-white font-semibold">Nueva Publicacion</span>
        <div style="width: 60px;"></div>
    </div>
    <div class="post-editor-preview">
        <img id="editor-preview-img" src="" alt="Preview">
        <video id="editor-preview-video" class="hidden" controls></video>
    </div>
    <div class="post-editor-footer">
        <textarea id="editor-caption" class="post-editor-input" rows="2"
            placeholder="Escribe un pie de foto..."></textarea>
        <button id="editor-submit" class="post-editor-submit">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
                    clip-rule="evenodd" />
            </svg>
            Dejar Huella
        </button>
    </div>
</div>

<!-- STORY CANVAS EDITOR -->
<div id="story-canvas-editor" class="story-canvas-editor">
    <div class="story-canvas-header">
        <button id="story-editor-cancel" class="text-white font-medium">Cancelar</button>
        <span class="text-white font-semibold">Editar Historia</span>
        <button id="story-editor-done" class="text-[#C5A059] font-semibold">Listo</button>
    </div>
    <div class="story-canvas-container">
        <canvas id="story-canvas"></canvas>
    </div>
    <div id="story-text-input-container" class="story-text-input-container">
        <input type="text" id="story-text-input" class="story-text-input" placeholder="Escribe algo...">
    </div>
    <div class="story-canvas-tools">
        <div class="story-brush-size" id="brush-sizes">
            <button class="story-brush-btn" data-size="3">
                <div class="story-brush-dot" style="width: 6px; height: 6px;"></div>
            </button>
            <button class="story-brush-btn active" data-size="6">
                <div class="story-brush-dot" style="width: 10px; height: 10px;"></div>
            </button>
            <button class="story-brush-btn" data-size="12">
                <div class="story-brush-dot" style="width: 16px; height: 16px;"></div>
            </button>
        </div>
        <div class="story-colors-row">
            <button class="story-color-btn active" data-color="#FFFFFF" style="background: #FFFFFF;"></button>
            <button class="story-color-btn" data-color="#FF0000" style="background: #FF0000;"></button>
            <button class="story-color-btn" data-color="#00FF00" style="background: #00FF00;"></button>
            <button class="story-color-btn" data-color="#0000FF" style="background: #0000FF;"></button>
            <button class="story-color-btn" data-color="#FFFF00" style="background: #FFFF00;"></button>
            <button class="story-color-btn" data-color="#FF00FF" style="background: #FF00FF;"></button>
            <button class="story-color-btn" data-color="#00FFFF" style="background: #00FFFF;"></button>
            <button class="story-color-btn" data-color="#000000" style="background: #000000;"></button>
        </div>
        <div class="story-tools-row">
            <button class="story-tool-btn active" data-tool="pen" title="Lapiz">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
            </button>
            <button class="story-tool-btn" data-tool="text" title="Texto">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                </svg>
            </button>
            <button class="story-tool-btn" data-tool="eraser" title="Borrador">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
            <button class="story-tool-btn" data-tool="undo" title="Deshacer">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                </svg>
            </button>
        </div>
        <button id="story-submit" class="story-submit-btn">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                    clip-rule="evenodd" />
            </svg>
            Subir Historia
        </button>
    </div>
</div>

<!-- STORY VIEWER -->
<div id="story-viewer" class="story-viewer">
    <div class="story-progress-container" id="story-progress-container"></div>
    <div class="story-header">
        <img id="story-viewer-avatar" src="" class="story-avatar-small">
        <div class="story-user-info">
            <p id="story-viewer-name" class="font-semibold"></p>
            <p id="story-viewer-time" class="text-xs opacity-80"></p>
        </div>
    </div>
    <button id="story-close" class="story-close">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>
    <div class="story-content">
        <img id="story-viewer-media" src="" class="hidden">
        <video id="story-viewer-video" class="hidden" autoplay></video>
    </div>
    <div class="story-nav">
        <div id="story-nav-prev" class="story-nav-prev"></div>
        <div id="story-nav-next" class="story-nav-next"></div>
    </div>
</div>

<!-- LOADING OVERLAY -->
<div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <p id="loading-text" class="mt-4 text-[#4B3621] font-medium">Cargando...</p>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- Hidden file inputs -->
<input type="file" id="gallery-input" class="hidden" accept="image/*,video/*">
</div>


<!-- FIREBASE & APP LOGIC -->
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, signOut, updateProfile, updatePassword } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, addDoc, onSnapshot, query, orderBy, where, limit, serverTimestamp, updateDoc, arrayUnion, arrayRemove, enableIndexedDbPersistence } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';

    const firebaseConfig = {
        apiKey: "AIzaSyBTJ1Gf__zEpi9SkA1LkJ8pYz4Jb0zkU8A",
        authDomain: "maria-s-cut.firebaseapp.com",
        projectId: "maria-s-cut",
        storageBucket: "maria-s-cut.firebasestorage.app",
        messagingSenderId: "387590858198",
        appId: "1:387590858198:web:0848e746b595543f0af077",
        measurementId: "G-CW33W93S9Y"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // === DIAGNOSTICO AGRESIVO: Persistencia + Test de conexion ===
    enableIndexedDbPersistence(db).then(() => {
        console.log('Persistencia IndexedDB activada OK');
    }).catch((err) => {
        console.error('Fallo persistencia:', err.code);
        if (err.code === 'failed-precondition') {
            console.warn('Multiples tabs abiertas, persistencia solo en una');
        } else if (err.code === 'unimplemented') {
            console.warn('Navegador no soporta persistencia');
        }
    });

    // Test inmediato de lectura
    getDocs(collection(db, 'posts')).then((snap) => {
        console.log('TEST DIRECTO: Documentos en posts:', snap.size);
        if (snap.size > 0) {
            snap.forEach((d) => console.log('  Doc:', d.id, JSON.stringify(d.data())));
        } else {
            alert('DIAGNOSTICO: La coleccion "posts" esta VACIA en Firestore. 0 documentos encontrados.');
        }
    }).catch((err) => {
        alert('DIAGNOSTICO: Error al leer Firestore: ' + err.code + ' - ' + err.message);
        console.error('Error lectura directa:', err);
    });

    const AppState = {
        currentUser: null,
        userData: null,
        isGuest: false,
        currentScreen: 'login',
        cameraMode: 'story',
        capturedMedia: null,
        stories: [],
        currentStoryIndex: 0,
        storyTimer: null,
        mediaStream: null,
        isInitializing: true,
        userPosts: [],
        userBookings: [],
        wizardStep: 1,
        wizardAnswers: {},
        wizardType: '',
        likedPosts: new Set()
    };

    const CanvasState = {
        canvas: null,
        ctx: null,
        isDrawing: false,
        currentTool: 'pen',
        currentColor: '#FFFFFF',
        currentSize: 6,
        drawingHistory: [],
        historyStep: -1,
        backgroundImage: null,
        textElements: [],
        isAddingText: false
    };

    // ===== UTILIDADES =====
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
            s.classList.add('hidden');
        });
        const screen = document.getElementById(screenId);
        if (screen) {
            screen.classList.remove('hidden');
            screen.classList.add('active');
        }
        AppState.currentScreen = screenId;
        updateNavState();

        if (screenId === 'screen-profile' && AppState.currentUser) {
            loadUserProfileData();
        }
    }

    function updateNavState() {
        const navItems = document.querySelectorAll('.nav-item, .nav-center-btn');
        navItems.forEach(item => {
            item.classList.remove('active');
            if (item.dataset.screen === AppState.currentScreen) {
                item.classList.add('active');
            }
        });
    }

    function showLoading(text = 'Cargando...') {
        document.getElementById('loading-text').textContent = text;
        document.getElementById('loading-overlay').classList.add('active');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.remove('active');
    }

    function showToast(message, type = 'default') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ===== MODALES Y ALERTAS =====
    window.openModal = function (modalId) {
        document.getElementById(modalId).classList.add('active');
    };

    window.closeModal = function (modalId) {
        document.getElementById(modalId).classList.remove('active');
    };

    window.openAlert = function (alertId) {
        document.getElementById(alertId).classList.add('active');
    };

    window.closeAlert = function (alertId) {
        document.getElementById(alertId).classList.remove('active');
    };

    // Side Menu
    document.getElementById('btn-menu').addEventListener('click', () => {
        document.getElementById('side-menu-overlay').classList.add('active');
        document.getElementById('side-menu').classList.add('active');
    });

    document.getElementById('side-menu-overlay').addEventListener('click', () => {
        document.getElementById('side-menu-overlay').classList.remove('active');
        document.getElementById('side-menu').classList.remove('active');
    });

    // ===== PERFIL - TABS =====
    document.querySelectorAll('.profile-tab, .profile-stat').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            switchProfileTab(tabName);
        });
    });

    function switchProfileTab(tabName) {
        document.querySelectorAll('.profile-tab').forEach(t => {
            t.classList.toggle('active', t.dataset.tab === tabName);
        });
        document.querySelectorAll('.profile-stat').forEach(s => {
            s.classList.toggle('active', s.dataset.tab === tabName);
        });
        document.querySelectorAll('[id^="tab-content-"]').forEach(c => {
            c.classList.add('hidden');
        });
        document.getElementById('tab-content-' + tabName).classList.remove('hidden');
    }

    // ===== PERFIL - CARGAR DATOS =====
    async function loadUserProfileData() {
        if (!AppState.currentUser) return;
        const uid = AppState.currentUser.uid;

        const postsQuery = query(
            collection(db, 'posts'),
            where('userId', '==', uid),
            orderBy('createdAt', 'desc')
        );

        onSnapshot(postsQuery, (snapshot) => {
            AppState.userPosts = [];
            const grid = document.getElementById('user-posts-grid');
            const empty = document.getElementById('posts-empty');

            if (snapshot.empty) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                document.getElementById('stat-posts').textContent = '0';
                return;
            }

            let html = '';
            snapshot.forEach((doc) => {
                const post = doc.data();
                AppState.userPosts.push(post);
                if (post.mediaType === 'image') {
                    html += '<div class="posts-grid-item"><img src="' + post.mediaUrl + '"></div>';
                }
            });

            grid.innerHTML = html;
            empty.classList.add('hidden');
            document.getElementById('stat-posts').textContent = AppState.userPosts.length;
        });

        const bookingsQuery = query(
            collection(db, 'bookings'),
            where('userId', '==', uid),
            orderBy('createdAt', 'desc')
        );

        onSnapshot(bookingsQuery, (snapshot) => {
            AppState.userBookings = [];
            const list = document.getElementById('user-bookings-list');
            const empty = document.getElementById('bookings-empty');

            if (snapshot.empty) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                document.getElementById('stat-citas').textContent = '0';
                return;
            }

            let html = '';
            snapshot.forEach((docSnap) => {
                const booking = docSnap.data();
                AppState.userBookings.push(booking);
                const fecha = booking.date ? new Date(booking.date.seconds * 1000).toLocaleDateString('es-CL') : 'Pendiente';
                html += '<div class="booking-item">' +
                    '<div class="booking-header">' +
                    '<span class="booking-service">' + (booking.service || 'Spa Deluxe') + '</span>' +
                    '<span class="booking-status ' + (booking.status || 'pendiente') + '">' + (booking.status || 'Pendiente') + '</span>' +
                    '</div>' +
                    '<div class="booking-date">' +
                    '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>' +
                    fecha + '</div></div>';
            });

            list.innerHTML = html;
            empty.classList.add('hidden');
            document.getElementById('stat-citas').textContent = AppState.userBookings.length;
        });

        try {
            const petDoc = await getDoc(doc(db, 'pets', uid));
            if (petDoc.exists()) {
                const pet = petDoc.data();
                document.getElementById('pet-name-input').value = pet.name || '';
                document.getElementById('pet-breed-input').value = pet.breed || '';
                document.getElementById('pet-age-input').value = pet.age || '';
                document.getElementById('pet-notes-input').value = pet.notes || '';
                if (pet.photoURL) {
                    document.getElementById('pet-avatar-img').src = pet.photoURL;
                }
            }
        } catch (error) {
            console.error('Error cargando datos de mascota:', error);
        }
    }

    // ===== MENU: MIS DATOS =====
    document.getElementById('menu-mis-datos').addEventListener('click', () => {
        document.getElementById('side-menu-overlay').classList.remove('active');
        document.getElementById('side-menu').classList.remove('active');
        document.getElementById('edit-name').value = AppState.userData?.name || '';
        document.getElementById('edit-phone').value = AppState.userData?.phone || '';
        document.getElementById('edit-email').value = AppState.currentUser?.email || '';
        document.getElementById('modal-avatar-img').src = AppState.currentUser?.photoURL || 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=200&h=200&fit=crop';
        openModal('modal-mis-datos');
    });

    document.getElementById('avatar-edit').addEventListener('click', () => {
        document.getElementById('avatar-input').click();
    });

    // FIX 4: FOTO DE PERFIL - Try/catch/finally para asegurar que el spinner se detenga
    document.getElementById('avatar-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        showLoading('Subiendo foto...');
        try {
            const storageRef = ref(storage, 'avatars/' + AppState.currentUser.uid + '.jpg');
            await uploadBytes(storageRef, file);
            const photoURL = await getDownloadURL(storageRef);
            await updateProfile(AppState.currentUser, { photoURL });
            document.getElementById('modal-avatar-img').src = photoURL;
            document.getElementById('profile-avatar').src = photoURL;
            showToast('Foto actualizada', 'success');
        } catch (error) {
            console.error('Error:', error);
            showToast('Error al subir foto', 'error');
        } finally {
            hideLoading();
        }
    });

    document.getElementById('btn-save-datos').addEventListener('click', async () => {
        const name = document.getElementById('edit-name').value.trim();
        const phone = document.getElementById('edit-phone').value.trim();
        const password = document.getElementById('edit-password').value;

        showLoading('Guardando...');
        try {
            await setDoc(doc(db, 'users', AppState.currentUser.uid), {
                name: name,
                phone: phone,
                email: AppState.currentUser.email
            }, { merge: true });

            await updateProfile(AppState.currentUser, { displayName: name });

            if (password && password.length >= 6) {
                await updatePassword(AppState.currentUser, password);
                showToast('Contrasena actualizada', 'success');
            }

            AppState.userData.name = name;
            AppState.userData.phone = phone;
            document.getElementById('profile-name').textContent = name;

            showToast('Datos guardados', 'success');
            closeModal('modal-mis-datos');
        } catch (error) {
            console.error('Error:', error);
            showToast('Error: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    });

    // ===== WIZARD =====
    document.getElementById('menu-entrenador').addEventListener('click', () => {
        document.getElementById('side-menu-overlay').classList.remove('active');
        document.getElementById('side-menu').classList.remove('active');
        startWizard('entrenador');
    });

    document.getElementById('menu-paseador').addEventListener('click', () => {
        document.getElementById('side-menu-overlay').classList.remove('active');
        document.getElementById('side-menu').classList.remove('active');
        startWizard('paseador');
    });

    function startWizard(type) {
        AppState.wizardType = type;
        AppState.wizardStep = 1;
        AppState.wizardAnswers = {};
        document.getElementById('wizard-title').textContent = type === 'entrenador' ? 'Solicitud de Entrenador' : 'Solicitud de Paseador';
        updateWizardUI();
        openModal('modal-wizard');
    }

    function updateWizardUI() {
        for (let i = 1; i <= 5; i++) {
            document.getElementById('progress-' + i).classList.toggle('fill', i <= AppState.wizardStep);
        }
        document.querySelectorAll('.wizard-step').forEach((step, index) => {
            step.classList.toggle('active', index + 1 === AppState.wizardStep);
        });
        document.getElementById('wizard-prev').style.visibility = AppState.wizardStep === 1 ? 'hidden' : 'visible';
        document.getElementById('wizard-next').textContent = AppState.wizardStep === 5 ? 'Finalizar' : 'Siguiente';
    }

    window.nextWizardStep = function () {
        const currentStepEl = document.getElementById('step-' + AppState.wizardStep);
        if (AppState.wizardStep < 5) {
            const selected = currentStepEl.querySelector('.option-card.selected');
            if (!selected) {
                showToast('Selecciona una opcion', 'info');
                return;
            }
            AppState.wizardAnswers['pregunta' + AppState.wizardStep] = selected.dataset.value;
        } else {
            AppState.wizardAnswers.about = document.getElementById('wizard-about').value;
        }

        if (AppState.wizardStep === 5) {
            submitWizard();
        } else {
            AppState.wizardStep++;
            updateWizardUI();
        }
    };

    window.prevWizardStep = function () {
        if (AppState.wizardStep > 1) {
            AppState.wizardStep--;
            updateWizardUI();
        }
    };

    document.querySelectorAll('.option-card').forEach(card => {
        card.addEventListener('click', function () {
            this.parentElement.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
        });
    });

    async function submitWizard() {
        showLoading('Enviando solicitud...');
        try {
            await addDoc(collection(db, 'solicitudes_staff'), {
                uid: AppState.currentUser.uid,
                tipo: AppState.wizardType,
                respuestas: AppState.wizardAnswers,
                estado: 'pendiente',
                userName: AppState.userData?.name || '',
                userEmail: AppState.currentUser.email,
                createdAt: serverTimestamp()
            });
            showToast('Solicitud enviada. Te contactaremos pronto!', 'success');
            closeModal('modal-wizard');
        } catch (error) {
            console.error('Error:', error);
            showToast('Error al enviar solicitud', 'error');
        } finally {
            hideLoading();
        }
    }

    // ===== LOGOUT =====
    document.getElementById('menu-logout').addEventListener('click', () => {
        document.getElementById('side-menu-overlay').classList.remove('active');
        document.getElementById('side-menu').classList.remove('active');
        openAlert('alert-logout');
    });

    document.getElementById('confirm-logout').addEventListener('click', async () => {
        closeAlert('alert-logout');
        try {
            await signOut(auth);
            AppState.isGuest = false;
            AppState.currentUser = null;
            AppState.userData = null;
            showToast('Sesion cerrada', 'success');
        } catch (error) {
            showToast('Error al cerrar sesion', 'error');
        }
    });

    // ===== NOTIFICACIONES =====
    const mockNotifications = [
        { id: 1, user: 'Maria', avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100', text: 'A <strong>Maria</strong> le gusto tu foto', time: 'Hace 5 min', unread: true },
        { id: 2, user: 'Juan', avatar: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=100', text: '<strong>Juan</strong> comento tu historia', time: 'Hace 1 hora', unread: true },
        { id: 3, user: 'Ana', avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100', text: '<strong>Ana</strong> comenzo a seguirte', time: 'Hace 3 horas', unread: true },
        { id: 4, user: 'Pedro', avatar: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=100', text: 'A <strong>Pedro</strong> le gusto tu publicacion', time: 'Ayer', unread: false },
        { id: 5, user: 'Maria\'s Cut', avatar: 'https://images.unsplash.com/photo-1587300003388-59208cc962cb?w=100', text: 'Tu cita ha sido <strong>confirmada</strong>', time: 'Hace 2 dias', unread: false }
    ];

    document.getElementById('btn-notifications').addEventListener('click', () => {
        renderNotifications();
        openModal('modal-notifications');
        document.getElementById('notif-badge').style.display = 'none';
    });

    function renderNotifications() {
        const container = document.getElementById('notifications-list');
        let html = '';
        mockNotifications.forEach(notif => {
            html += '<div class="notification-item ' + (notif.unread ? 'unread' : '') + '">' +
                '<img src="' + notif.avatar + '" class="notification-avatar">' +
                '<div class="notification-content">' +
                '<p class="notification-text">' + notif.text + '</p>' +
                '<p class="notification-time">' + notif.time + '</p>' +
                '</div>' +
                (notif.unread ? '<div class="notification-dot"></div>' : '') +
                '</div>';
        });
        container.innerHTML = html;
    }

    // ===== MASCOTA =====
    document.getElementById('pet-avatar-upload').addEventListener('click', () => {
        document.getElementById('pet-avatar-input').click();
    });

    document.getElementById('pet-avatar-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        showLoading('Subiendo foto...');
        try {
            const storageRef = ref(storage, 'pets/' + AppState.currentUser.uid + '.jpg');
            await uploadBytes(storageRef, file);
            const photoURL = await getDownloadURL(storageRef);
            document.getElementById('pet-avatar-img').src = photoURL;
            showToast('Foto actualizada', 'success');
        } catch (error) {
            showToast('Error al subir foto', 'error');
        } finally {
            hideLoading();
        }
    });

    document.getElementById('btn-save-pet').addEventListener('click', async () => {
        const petData = {
            name: document.getElementById('pet-name-input').value,
            breed: document.getElementById('pet-breed-input').value,
            age: document.getElementById('pet-age-input').value,
            notes: document.getElementById('pet-notes-input').value,
            ownerId: AppState.currentUser.uid,
            updatedAt: serverTimestamp()
        };

        showLoading('Guardando...');
        try {
            await setDoc(doc(db, 'pets', AppState.currentUser.uid), petData, { merge: true });
            showToast('Datos guardados', 'success');
        } catch (error) {
            showToast('Error al guardar', 'error');
        } finally {
            hideLoading();
        }
    });

    // ===== FIX 1: AUTH STATE CON AWAIT PARA LOADUSERDATA =====
    onAuthStateChanged(auth, async (user) => {
        const nav = document.getElementById('bottom-nav');
        if (AppState.isInitializing) {
            showLoading('Iniciando aplicacion...');
        }
        try {
            if (!user && !AppState.isGuest) {
                AppState.currentUser = null;
                AppState.userData = null;
                showScreen('screen-login');
                nav.classList.add('hidden');
            } else {
                AppState.currentUser = user;
                if (user && !AppState.isGuest) {
                    // FIX CRITICO: Esperar a que loadUserData termine antes de mostrar la app
                    const dataLoaded = await loadUserData(user.uid);
                    if (!dataLoaded) {
                        console.warn('No se pudieron cargar los datos del usuario');
                    }
                } else {
                    AppState.userData = { name: 'Invitado', petName: '' };
                }
                showScreen('screen-grooming');
                nav.classList.remove('hidden');
                loadFeed();
                loadStories();
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('Error al cargar');
            showScreen('screen-login');
            nav.classList.add('hidden');
        } finally {
            hideLoading();
            AppState.isInitializing = false;
        }
    });

    // FIX 1: Funcion loadUserData que retorna Promise para poder hacer await
    async function loadUserData(uid) {
        if (!uid) return false;
        try {
            const userDoc = await getDoc(doc(db, 'users', uid));
            if (userDoc.exists()) {
                AppState.userData = userDoc.data();
                // Actualizar DOM del perfil inmediatamente
                document.getElementById('profile-name').textContent = AppState.userData.name || 'Usuario';
                document.getElementById('profile-pet').textContent = AppState.userData.petName ? ' ' + AppState.userData.petName : '';
                if (AppState.currentUser?.photoURL) {
                    document.getElementById('profile-avatar').src = AppState.currentUser.photoURL;
                }
                return true;
            } else {
                // Si no existe el documento, crear uno basico
                AppState.userData = { name: 'Usuario', petName: '' };
                document.getElementById('profile-name').textContent = 'Usuario';
                document.getElementById('profile-pet').textContent = '';
                return true;
            }
        } catch (error) {
            console.error('Error cargando datos de usuario:', error);
            // En caso de error, mostrar valores por defecto para evitar "Cargando..."
            document.getElementById('profile-name').textContent = 'Usuario';
            document.getElementById('profile-pet').textContent = '';
            return false;
        }
    }


    // ===== LOGIN =====
    const loginActions = document.getElementById('login-actions');
    const registerActions = document.getElementById('register-actions');
    const registerFields = document.getElementById('register-fields');
    const errorEl = document.getElementById('login-error');

    document.getElementById('btn-show-register').addEventListener('click', () => {
        loginActions.classList.add('hidden');
        registerActions.classList.remove('hidden');
        registerFields.classList.remove('hidden');
        errorEl.classList.add('hidden');
    });

    document.getElementById('btn-show-login').addEventListener('click', () => {
        registerActions.classList.add('hidden');
        loginActions.classList.remove('hidden');
        registerFields.classList.add('hidden');
        errorEl.classList.add('hidden');
    });

    document.getElementById('btn-login').addEventListener('click', async () => {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        if (!email || !password) {
            showError('Ingresa tu email y contrasena');
            return;
        }
        showLoading('Iniciando sesion...');
        hideError();
        try {
            await signInWithEmailAndPassword(auth, email, password);
        } catch (error) {
            if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                showError('Usuario o contrasena incorrectos');
            } else {
                showError('Error al entrar: ' + error.message);
            }
        } finally {
            hideLoading();
        }
    });

    document.getElementById('btn-register').addEventListener('click', async () => {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const name = document.getElementById('login-name').value.trim();
        const pet = document.getElementById('login-pet').value.trim();
        const phone = document.getElementById('login-phone').value.trim();

        if (!email || !password || !name) {
            showError('Email, contrasena y nombre son obligatorios');
            return;
        }
        if (password.length < 6) {
            showError('La contrasena debe tener al menos 6 caracteres');
            return;
        }

        showLoading('Creando cuenta...');
        hideError();
        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            await setDoc(doc(db, 'users', userCredential.user.uid), {
                name: name, email: email, petName: pet || 'Mi Mascota', phone: phone || '', createdAt: serverTimestamp()
            });
            await updateProfile(userCredential.user, { displayName: name });
            AppState.userData = { name: name, email: email, petName: pet || 'Mi Mascota', phone: phone || '' };
            showToast('Cuenta creada!', 'success');
        } catch (error) {
            if (error.code === 'auth/email-already-in-use') {
                showError('Este correo ya esta registrado');
            } else {
                showError('Error: ' + error.message);
            }
        } finally {
            hideLoading();
        }
    });

    function showError(msg) {
        errorEl.textContent = msg;
        errorEl.classList.remove('hidden');
    }
    function hideError() { errorEl.classList.add('hidden'); }

    document.getElementById('btn-skip').addEventListener('click', async () => {
        showLoading('Entrando como invitado...');
        try {
            AppState.isGuest = true;
            await signInAnonymously(auth);
        } catch (error) {
            hideLoading();
            showToast('Error al entrar como invitado', 'error');
            AppState.isGuest = false;
        }
    });

    // ===== NAVEGACION =====
    document.querySelectorAll('.nav-item, .nav-center-btn').forEach(item => {
        item.addEventListener('click', () => {
            const screenId = item.dataset.screen;
            if (screenId) showScreen(screenId);
        });
    });

    document.getElementById('btn-booking').addEventListener('click', () => showScreen('screen-booking'));
    document.getElementById('btn-continue-payment').addEventListener('click', () => showScreen('screen-payment'));
    document.getElementById('btn-stripe-pay').addEventListener('click', () => {
        window.open('https://buy.stripe.com/14A8wH1Yjd6E0The7Adby00', '_blank');
    });

    // ===== CAMERA =====
    const cameraOverlay = document.getElementById('camera-overlay');
    const cameraVideo = document.getElementById('camera-video');
    const cameraCanvas = document.getElementById('camera-canvas');

    async function startCamera() {
        if (AppState.isGuest) {
            showToast('Registrate para publicar', 'info');
            return;
        }
        try {
            AppState.mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
            cameraVideo.srcObject = AppState.mediaStream;
            cameraOverlay.classList.add('active');
        } catch (error) {
            showToast('No se pudo acceder a la camara', 'error');
            document.getElementById('gallery-input').click();
        }
    }

    function stopCamera() {
        if (AppState.mediaStream) {
            AppState.mediaStream.getTracks().forEach(track => track.stop());
            AppState.mediaStream = null;
        }
        cameraOverlay.classList.remove('active');
    }

    document.getElementById('btn-add-content').addEventListener('click', () => {
        if (AppState.isGuest) { showToast('Registrate para publicar', 'info'); return; }
        AppState.cameraMode = 'post';
        updateCameraModeUI();
        startCamera();
    });

    function updateCameraModeUI() {
        document.querySelectorAll('.camera-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === AppState.cameraMode);
        });
    }

    document.getElementById('camera-close').addEventListener('click', stopCamera);
    document.querySelectorAll('.camera-mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.camera-mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            AppState.cameraMode = btn.dataset.mode;
        });
    });

    document.getElementById('camera-capture').addEventListener('click', () => {
        const context = cameraCanvas.getContext('2d');
        cameraCanvas.width = cameraVideo.videoWidth;
        cameraCanvas.height = cameraVideo.videoHeight;
        context.drawImage(cameraVideo, 0, 0);
        cameraCanvas.toBlob((blob) => {
            AppState.capturedMedia = { blob, type: 'image' };
            stopCamera();
            if (AppState.cameraMode === 'story') openStoryCanvasEditor();
            else openPostEditor();
        }, 'image/jpeg', 0.9);
    });

    document.getElementById('camera-gallery-btn').addEventListener('click', () => {
        document.getElementById('gallery-input').click();
    });

    document.getElementById('gallery-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            AppState.capturedMedia = { blob: file, type: file.type.startsWith('video') ? 'video' : 'image' };
            stopCamera();
            if (AppState.cameraMode === 'story') openStoryCanvasEditor();
            else openPostEditor();
        }
    });

    // ===== STORY CANVAS =====
    function openStoryCanvasEditor() {
        if (AppState.isGuest) { showToast('Registrate para publicar', 'info'); return; }
        const modal = document.getElementById('story-canvas-editor');
        const canvas = document.getElementById('story-canvas');
        CanvasState.canvas = canvas;
        CanvasState.ctx = canvas.getContext('2d');
        CanvasState.drawingHistory = [];
        CanvasState.historyStep = -1;
        const img = new Image();
        img.onload = () => {
            CanvasState.backgroundImage = img;
            const maxWidth = window.innerWidth;
            const maxHeight = window.innerHeight * 0.65;
            const scale = Math.min(maxWidth / img.width, maxHeight / img.height);
            canvas.width = img.width;
            canvas.height = img.height;
            canvas.style.width = (img.width * scale) + 'px';
            canvas.style.height = (img.height * scale) + 'px';
            redrawCanvas();
        };
        img.src = URL.createObjectURL(AppState.capturedMedia.blob);
        modal.classList.add('active');
        setupCanvasEvents();
    }

    function setupCanvasEvents() {
        const canvas = CanvasState.canvas;
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
        canvas.addEventListener('touchend', handleTouchEnd);
        canvas.addEventListener('mousedown', handleMouseDown);
        canvas.addEventListener('mousemove', handleMouseMove);
        canvas.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('mouseleave', handleMouseUp);
    }

    function getCanvasCoordinates(e) {
        const canvas = CanvasState.canvas;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        let clientX, clientY;
        if (e.touches && e.touches.length > 0) {
            clientX = e.touches[0].clientX;
            clientY = e.touches[0].clientY;
        } else {
            clientX = e.clientX;
            clientY = e.clientY;
        }
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    function handleTouchStart(e) {
        if (CanvasState.currentTool === 'text') return;
        e.preventDefault();
        CanvasState.isDrawing = true;
        const coords = getCanvasCoordinates(e);
        CanvasState.lastX = coords.x;
        CanvasState.lastY = coords.y;
    }

    function handleTouchMove(e) {
        if (!CanvasState.isDrawing || CanvasState.currentTool === 'text') return;
        e.preventDefault();
        const coords = getCanvasCoordinates(e);
        draw(coords.x, coords.y);
    }

    function handleTouchEnd(e) {
        if (CanvasState.isDrawing) {
            CanvasState.isDrawing = false;
            saveDrawingState();
        }
    }

    function handleMouseDown(e) {
        if (CanvasState.currentTool === 'text') return;
        CanvasState.isDrawing = true;
        const coords = getCanvasCoordinates(e);
        CanvasState.lastX = coords.x;
        CanvasState.lastY = coords.y;
    }

    function handleMouseMove(e) {
        if (!CanvasState.isDrawing || CanvasState.currentTool === 'text') return;
        const coords = getCanvasCoordinates(e);
        draw(coords.x, coords.y);
    }

    function handleMouseUp(e) {
        if (CanvasState.isDrawing) {
            CanvasState.isDrawing = false;
            saveDrawingState();
        }
    }

    function draw(x, y) {
        const ctx = CanvasState.ctx;
        ctx.lineWidth = CanvasState.currentSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        if (CanvasState.currentTool === 'eraser') {
            ctx.globalCompositeOperation = 'destination-out';
        } else {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = CanvasState.currentColor;
        }
        ctx.beginPath();
        ctx.moveTo(CanvasState.lastX, CanvasState.lastY);
        ctx.lineTo(x, y);
        ctx.stroke();
        CanvasState.lastX = x;
        CanvasState.lastY = y;
    }

    function saveDrawingState() {
        CanvasState.historyStep++;
        if (CanvasState.historyStep < CanvasState.drawingHistory.length) {
            CanvasState.drawingHistory.length = CanvasState.historyStep;
        }
        CanvasState.drawingHistory.push(CanvasState.canvas.toDataURL());
    }

    function undo() {
        if (CanvasState.historyStep > 0) {
            CanvasState.historyStep--;
            const img = new Image();
            img.onload = () => {
                CanvasState.ctx.clearRect(0, 0, CanvasState.canvas.width, CanvasState.canvas.height);
                CanvasState.ctx.drawImage(img, 0, 0);
            };
            img.src = CanvasState.drawingHistory[CanvasState.historyStep];
        } else if (CanvasState.historyStep === 0) {
            CanvasState.historyStep = -1;
            redrawCanvas(true);
        }
    }

    function redrawCanvas(clearOnly = false) {
        const canvas = CanvasState.canvas;
        const ctx = CanvasState.ctx;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!clearOnly && CanvasState.backgroundImage) {
            ctx.drawImage(CanvasState.backgroundImage, 0, 0);
        }
    }

    document.querySelectorAll('.story-tool-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const tool = btn.dataset.tool;
            if (tool === 'undo') { undo(); return; }
            CanvasState.currentTool = tool;
            document.querySelectorAll('.story-tool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if (tool === 'text') showTextInput();
            else hideTextInput();
        });
    });

    document.querySelectorAll('.story-color-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            CanvasState.currentColor = btn.dataset.color;
            document.querySelectorAll('.story-color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });

    document.querySelectorAll('.story-brush-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            CanvasState.currentSize = parseInt(btn.dataset.size);
            document.querySelectorAll('.story-brush-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });

    function showTextInput() {
        const container = document.getElementById('story-text-input-container');
        const input = document.getElementById('story-text-input');
        container.classList.add('active');
        input.value = '';
        input.focus();
    }

    function hideTextInput() {
        document.getElementById('story-text-input-container').classList.remove('active');
    }

    document.getElementById('story-text-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            const text = e.target.value.trim();
            if (text) addTextToCanvas(text);
            hideTextInput();
            CanvasState.currentTool = 'pen';
            document.querySelectorAll('.story-tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-tool="pen"]').classList.add('active');
        }
    });

    function addTextToCanvas(text) {
        const ctx = CanvasState.ctx;
        const canvas = CanvasState.canvas;
        ctx.save();
        ctx.font = 'bold 48px sans-serif';
        ctx.fillStyle = CanvasState.currentColor;
        ctx.textAlign = 'center';
        ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.fillText(text, canvas.width / 2, canvas.height / 2);
        ctx.restore();
        saveDrawingState();
    }

    document.getElementById('story-editor-cancel').addEventListener('click', () => {
        document.getElementById('story-canvas-editor').classList.remove('active');
        AppState.capturedMedia = null;
    });

    document.getElementById('story-editor-done').addEventListener('click', hideTextInput);

    function openPostEditor() {
        if (AppState.isGuest) { showToast('Registrate para publicar', 'info'); return; }
        const modal = document.getElementById('post-editor-modal');
        const previewImg = document.getElementById('editor-preview-img');
        const previewVideo = document.getElementById('editor-preview-video');
        const caption = document.getElementById('editor-caption');
        caption.value = '';
        if (AppState.capturedMedia.type === 'image') {
            previewImg.classList.remove('hidden');
            previewVideo.classList.add('hidden');
            previewImg.src = URL.createObjectURL(AppState.capturedMedia.blob);
        } else {
            previewImg.classList.add('hidden');
            previewVideo.classList.remove('hidden');
            previewVideo.src = URL.createObjectURL(AppState.capturedMedia.blob);
        }
        modal.classList.add('active');
    }

    document.getElementById('editor-cancel').addEventListener('click', () => {
        document.getElementById('post-editor-modal').classList.remove('active');
        AppState.capturedMedia = null;
    });

    async function mergeCanvasToImage() {
        const canvas = CanvasState.canvas;
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvas.width;
        tempCanvas.height = canvas.height;
        const tempCtx = tempCanvas.getContext('2d');
        if (CanvasState.backgroundImage) tempCtx.drawImage(CanvasState.backgroundImage, 0, 0);
        tempCtx.drawImage(canvas, 0, 0);
        return new Promise((resolve) => {
            tempCanvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.95);
        });
    }

    document.getElementById('story-submit').addEventListener('click', async () => {
        if (AppState.isGuest) { showToast('Registrate para publicar', 'info'); return; }
        document.getElementById('story-canvas-editor').classList.remove('active');
        showToast('Subiendo historia...', 'info');
        try {
            const mergedBlob = await mergeCanvasToImage();
            const fileName = 'stories/' + Date.now() + '_' + AppState.currentUser.uid + '.jpg';
            const storageRef = ref(storage, fileName);
            const uploadTask = uploadBytesResumable(storageRef, mergedBlob);
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed', null, (error) => reject(error), () => resolve());
            });
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            await addDoc(collection(db, 'stories'), {
                imageUrl: downloadURL,
                userId: AppState.currentUser.uid,
                userName: AppState.currentUser.displayName || AppState.userData?.name || 'Usuario',
                userPhoto: AppState.currentUser?.photoURL || '',
                mediaType: 'image',
                createdAt: serverTimestamp(),
                expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000)
            });
            console.log('\u2705 Historia registrada en Firestore');
            showToast('Historia publicada!', 'success');
            AppState.capturedMedia = null;
        } catch (error) {
            console.error('Error al publicar historia:', error);
            showToast('Error: ' + error.message, 'error');
        }
    });

    document.getElementById('editor-submit').addEventListener('click', async () => {
        if (AppState.isGuest) { showToast('Registrate para publicar', 'info'); return; }
        if (!AppState.capturedMedia || !AppState.capturedMedia.blob) {
            alert('ERROR: No hay imagen capturada (capturedMedia es null)');
            return;
        }
        const caption = document.getElementById('editor-caption').value.trim();
        document.getElementById('post-editor-modal').classList.remove('active');
        showToast('Subiendo...', 'info');
        try {
            // Paso 1: Subir imagen a Storage
            const fileName = 'posts/' + Date.now() + '_' + AppState.currentUser.uid + '.jpg';
            const storageRef = ref(storage, fileName);
            const uploadTask = uploadBytesResumable(storageRef, AppState.capturedMedia.blob);
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed', null, (error) => reject(error), () => resolve());
            });
            // Paso 2: Obtener URL
            const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
            alert('Imagen subida a Storage OK. URL: ' + downloadURL.substring(0, 60) + '... Iniciando escritura en Firestore...');
            // Paso 3: Crear documento en Firestore
            try {
                const docRef = await addDoc(collection(db, 'posts'), {
                    imageUrl: downloadURL,
                    caption: caption || '\ud83d\udc3e',
                    createdAt: serverTimestamp(),
                    userId: AppState.currentUser.uid,
                    userName: AppState.currentUser.displayName || AppState.userData?.name || 'Usuario',
                    userPhoto: AppState.currentUser?.photoURL || '',
                    mediaType: AppState.capturedMedia.type || 'image',
                    likes: [],
                    comments: []
                });
                alert('\u2705 POST GUARDADO EN FIRESTORE! ID: ' + docRef.id);
                showToast('Publicacion creada!', 'success');
            } catch (firestoreErr) {
                alert('\u274c FIRESTORE RECHAZO LA ESCRITURA: ' + firestoreErr.code + ' - ' + firestoreErr.message);
                console.error('Firestore write error:', firestoreErr);
            }
            AppState.capturedMedia = null;
        } catch (error) {
            alert('\u274c ERROR EN STORAGE: ' + error.code + ' - ' + error.message);
            console.error('Storage error:', error);
        }
    });


    // ===== FEED PUBLICO - TIEMPO REAL (CON DIAGNOSTICO) =====
    function loadFeed() {
        try {
            const feedContainer = document.getElementById('feed-container');
            if (!feedContainer) { alert('ERROR: No se encuentra el elemento feed-container en el DOM'); return; }
            const postsQuery = query(collection(db, 'posts'), orderBy('createdAt', 'desc'), limit(50));

            onSnapshot(postsQuery, (snapshot) => {
                console.log('FEED onSnapshot: documentos recibidos:', snapshot.size);
                if (snapshot.empty) {
                    feedContainer.innerHTML = '<div style="text-align:center;padding:40px;color:#6D5D4E;"><p style="font-size:18px;font-weight:bold;">Feed vacio</p><p>No hay posts con campo createdAt</p></div>';
                    // Intento sin orderBy para ver si hay datos
                    getDocs(collection(db, 'posts')).then((rawSnap) => {
                        if (rawSnap.size > 0) {
                            alert('HAY ' + rawSnap.size + ' docs en posts, pero NO tienen createdAt. Campos del primer doc: ' + Object.keys(rawSnap.docs[0].data()).join(', '));
                        }
                    });
                    return;
                }
                let html = '';
                snapshot.forEach((docSnap) => {
                    const post = docSnap.data();
                    const postId = docSnap.id;
                    const likes = post.likes || [];
                    const comments = post.comments || [];
                    const isLiked = AppState.currentUser && likes.includes(AppState.currentUser.uid);
                    const likeCount = likes.length;
                    const commentCount = comments.length;

                    html += '<div class="social-card">';
                    html += '<div class="flex items-center p-3">';
                    html += '<img src="' + (post.userPhoto || 'https://randomuser.me/api/portraits/lego/1.jpg') + '" class="w-8 h-8 rounded-full object-cover mr-2">';
                    html += '<div><h4 class="text-sm font-bold text-[#4B3621]">' + post.userName + '</h4></div>';
                    html += '</div>';

                    if (post.mediaType === 'video') {
                        html += '<video src="' + (post.imageUrl || post.mediaUrl) + '" class="post-media" controls></video>';
                    } else {
                        html += '<img src="' + (post.imageUrl || post.mediaUrl) + '" class="post-media">';
                    }

                    html += '<div class="post-actions">';
                    html += '<button class="post-action-btn ' + (isLiked ? 'liked' : '') + '" onclick="window.toggleLike(\'' + postId + '\', this)" data-post-id="' + postId + '">';
                    html += '<svg fill="' + (isLiked ? '#EF4444' : 'none') + '" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>';
                    html += '<span class="post-action-count like-count">' + likeCount + '</span>';
                    html += '</button>';

                    html += '<button class="post-action-btn" onclick="window.showComments(\'' + postId + '\')">';
                    html += '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>';
                    html += '<span class="post-action-count">' + commentCount + '</span>';
                    html += '</button>';

                    html += '<button class="post-action-btn" onclick="window.sharePost(\'' + postId + '\', \'' + encodeURIComponent(post.caption || '') + '\')">';
                    html += '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>';
                    html += '</button>';
                    html += '</div>';

                    html += '<div class="post-caption">';
                    html += '<p class="post-caption-text"><span class="username">' + post.userName + '</span> ' + (post.caption || '\ud83d\udc3e') + '</p>';
                    html += '</div>';
                    html += '</div>';
                });
                feedContainer.innerHTML = html;
            }, (error) => {
                alert('ERROR EN FEED onSnapshot: ' + error.code + ' - ' + error.message);
                console.error('Feed onSnapshot error:', error);
            });
        } catch (e) {
            alert('ERROR CRITICO en loadFeed: ' + e.message);
            console.error('loadFeed crash:', e);
        }
    }

    // Toggle Like - funcion global
    window.toggleLike = async function (postId, btn) {
        if (AppState.isGuest || !AppState.currentUser) {
            showToast('Registrate para dar like', 'info');
            return;
        }

        const postRef = doc(db, 'posts', postId);
        const isLiked = btn.classList.contains('liked');

        try {
            if (isLiked) {
                await updateDoc(postRef, { likes: arrayRemove(AppState.currentUser.uid) });
                btn.classList.remove('liked');
                btn.querySelector('svg').setAttribute('fill', 'none');
            } else {
                await updateDoc(postRef, { likes: arrayUnion(AppState.currentUser.uid) });
                btn.classList.add('liked');
                btn.querySelector('svg').setAttribute('fill', '#EF4444');
            }
        } catch (error) {
            console.error('Error al dar like:', error);
            showToast('Error al procesar like', 'error');
        }
    };

    // Show Comments - funcion global
    window.showComments = function (postId) {
        if (AppState.isGuest) {
            showToast('Registrate para comentar', 'info');
            return;
        }
        // Por ahora solo mostramos un toast, en una version futura se abriria un modal
        showToast('Comentarios proximamente', 'info');
    };

    // Share Post - funcion global
    window.sharePost = async function (postId, caption) {
        const decodedCaption = decodeURIComponent(caption);
        const shareData = {
            title: 'Maria\'s Cut - Social Club',
            text: decodedCaption || 'Mira esta publicacion en Maria\'s Cut! ',
            url: window.location.href + '?post=' + postId
        };

        try {
            if (navigator.share) {
                await navigator.share(shareData);
                showToast('Compartido!', 'success');
            } else {
                // Fallback: copiar al portapapeles
                await navigator.clipboard.writeText(shareData.url);
                showToast('Link copiado al portapapeles', 'success');
            }
        } catch (error) {
            console.error('Error al compartir:', error);
            showToast('Error al compartir', 'error');
        }
    };

    // ===== HISTORIAS - TIEMPO REAL =====
    function loadStories() {
        const storiesContainer = document.getElementById('stories-container');
        const storiesQuery = query(collection(db, 'stories'), orderBy('createdAt', 'desc'));

        onSnapshot(storiesQuery, (snapshot) => {
            AppState.stories = [];
            const now = Date.now();
            const twentyFourHours = 24 * 60 * 60 * 1000;

            let html = '<div class="story-item" id="btn-add-story"><div class="story-avatar-ring" style="background: transparent; border: 2px dashed #C5A059;"><div class="w-full h-full bg-white rounded-full flex items-center justify-center"><svg class="w-6 h-6 text-[#C5A059]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg></div></div><span class="text-xs text-[#6D5D4E] mt-1">Tu Historia</span></div>';

            snapshot.forEach((docSnap) => {
                const story = { id: docSnap.id, ...docSnap.data() };

                // FIX CRITICO: Filtrar historias mayores a 24h en el cliente
                const storyTime = story.createdAt?.toMillis ? story.createdAt.toMillis() : new Date(story.createdAt).getTime();
                if (now - storyTime > twentyFourHours) {
                    return; // Skip historias viejas
                }

                AppState.stories.push(story);
                html += '<div class="story-item" data-story-id="' + story.id + '"><div class="story-avatar-ring unseen"><img src="' + (story.imageUrl || story.mediaUrl) + '" class="story-avatar"></div><span class="text-xs text-[#4B3621] mt-1 font-medium">' + story.userName + '</span></div>';
            });

            storiesContainer.innerHTML = html;

            document.getElementById('btn-add-story').addEventListener('click', () => {
                if (AppState.isGuest) { showToast('Registrate para publicar', 'info'); return; }
                AppState.cameraMode = 'story';
                updateCameraModeUI();
                startCamera();
            });

            document.querySelectorAll('.story-item[data-story-id]').forEach(item => {
                item.addEventListener('click', () => {
                    const storyId = item.dataset.storyId;
                    const index = AppState.stories.findIndex(s => s.id === storyId);
                    if (index !== -1) openStoryViewer(index);
                });
            });
        });
    }

    function openStoryViewer(startIndex = 0) {
        if (AppState.stories.length === 0) return;
        AppState.currentStoryIndex = startIndex;
        const viewer = document.getElementById('story-viewer');
        viewer.classList.add('active');
        const progressContainer = document.getElementById('story-progress-container');
        progressContainer.innerHTML = AppState.stories.map((_, i) => '<div class="story-progress-bar"><div class="story-progress-fill ' + (i === startIndex ? 'active' : '') + '" id="progress-' + i + '"></div></div>').join('');
        showCurrentStory();
    }

    function showCurrentStory() {
        const story = AppState.stories[AppState.currentStoryIndex];
        if (!story) { closeStoryViewer(); return; }

        AppState.stories.forEach((_, i) => {
            const fill = document.getElementById('progress-' + i);
            if (fill) {
                fill.classList.remove('active');
                fill.style.width = i < AppState.currentStoryIndex ? '100%' : '0%';
            }
        });

        const currentFill = document.getElementById('progress-' + AppState.currentStoryIndex);
        if (currentFill) currentFill.classList.add('active');

        document.getElementById('story-viewer-name').textContent = story.userName;
        document.getElementById('story-viewer-avatar').src = story.userPhoto || 'https://randomuser.me/api/portraits/lego/1.jpg';

        // Mostrar tiempo relativo
        const storyTime = story.createdAt?.toMillis ? story.createdAt.toMillis() : new Date(story.createdAt).getTime();
        const hoursAgo = Math.floor((Date.now() - storyTime) / (1000 * 60 * 60));
        const timeText = hoursAgo < 1 ? 'Hace menos de 1 hora' : 'Hace ' + hoursAgo + ' hora' + (hoursAgo > 1 ? 's' : '');
        document.getElementById('story-viewer-time').textContent = timeText;

        const mediaImg = document.getElementById('story-viewer-media');
        const mediaVideo = document.getElementById('story-viewer-video');
        if (story.mediaType === 'video') {
            mediaImg.classList.add('hidden');
            mediaVideo.classList.remove('hidden');
            mediaVideo.src = story.imageUrl || story.mediaUrl;
            mediaVideo.play();
        } else {
            mediaVideo.classList.add('hidden');
            mediaImg.classList.remove('hidden');
            mediaImg.src = story.imageUrl || story.mediaUrl;
        }
        clearTimeout(AppState.storyTimer);
        AppState.storyTimer = setTimeout(() => nextStory(), 10000);
    }

    function nextStory() {
        if (AppState.currentStoryIndex < AppState.stories.length - 1) {
            AppState.currentStoryIndex++;
            showCurrentStory();
        } else {
            closeStoryViewer();
        }
    }

    function prevStory() {
        if (AppState.currentStoryIndex > 0) {
            AppState.currentStoryIndex--;
            showCurrentStory();
        }
    }

    function closeStoryViewer() {
        clearTimeout(AppState.storyTimer);
        document.getElementById('story-viewer').classList.remove('active');
        document.getElementById('story-viewer-video').pause();
    }

    document.getElementById('story-close').addEventListener('click', closeStoryViewer);
    document.getElementById('story-nav-next').addEventListener('click', nextStory);
    document.getElementById('story-nav-prev').addEventListener('click', prevStory);

    // ===== CHAT =====
    document.getElementById('btn-send-chat').addEventListener('click', sendChatMessage);
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChatMessage();
    });

    function sendChatMessage() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;
        const container = document.getElementById('chat-messages');
        container.innerHTML += '<div class="chat-bubble user">' + msg + '</div>';
        input.value = '';
        container.scrollTop = container.scrollHeight;
        setTimeout(() => {
            const responses = [
                "Entiendo. Para mas informacion, contactanos al +56 9 1234 5678 ",
                "Buena pregunta! Te sugiero visitar nuestra sede en Av. Providencia 1234 ",
                "Perfecto, anotado. Algo mas en lo que pueda ayudarte?",
                "Claro, te recomiendo agendar una cita para que tu mascota reciba la mejor atencion "
            ];
            const resp = responses[Math.floor(Math.random() * responses.length)];
            container.innerHTML += '<div class="chat-bubble bot">' + resp + '</div>';
            container.scrollTop = container.scrollHeight;
        }, 800);
    }

    console.log('Maria\'s Cut App - FIXED EDITION v2.0');
    console.log('FIXES APLICADOS:');
    console.log('1. Perfil "Cargando" - loadUserData con await');
    console.log('2. Feed publico con likes/comments/share');
    console.log('3. Historias filtradas 24h en cliente');
    console.log('4. Foto de perfil con try/catch/finally');
</script>
</body>

</html>